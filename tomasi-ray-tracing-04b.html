<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="Maurizio Tomasi maurizio.tomasi@unimi.it">
  <title>Esercitazione 4</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@^4//dist/reset.css">
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@^4//dist/reveal.css">
  <style>
    .reveal .sourceCode {  /* see #7635 */
      /* overflow: visible; */
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@^4//dist/theme/white.css" id="theme">
  <link rel="stylesheet" href="./css/custom.css"/>
  <link rel="stylesheet" href="./css/asciinema-player.css"/>
  <script defer=""
  src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <link rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css" />
</head>
<body>
  <div class="reveal">
    <div class="slides">

<section id="title-slide">
  <h1 class="title">Esercitazione 4</h1>
  <p class="subtitle">Calcolo numerico per la generazione di immagini
fotorealistiche</p>
  <p class="author">Maurizio Tomasi <a
href="mailto:maurizio.tomasi@unimi.it"
class="email">maurizio.tomasi@unimi.it</a></p>
</section>

<section id="scrittura-di-immagini-ldr" class="slide level1">
<h1>Scrittura di immagini LDR</h1>
</section>
<section id="interfaccia-del-programma" class="slide level1">
<h1>Interfaccia del programma</h1>
<ul>
<li><p>Oggi implementeremo il codice del nostro programma
(<code>main.py</code> nella versione Python).</p></li>
<li><p>Il funzionamento del programma in questa versione sarà il
seguente:</p>
<pre class="text"><code>$ ./main.py input_file.pfm 0.3 1.0 output_file.png
File &#39;input_file.pfm&#39; has been read from disk
File &#39;output_file.png&#39; has been written to disk
$</code></pre></li>
<li><p>Lo scopo è quello di convertire un file PFM in un file PNG (o nel
formato LDR che preferite). I valori <code>0.3</code> e <code>1.0</code>
fanno riferimento al <a
href="./tomasi-ray-tracing-05b-external-libraries.html#/normalizzazione">fattore
di scala</a> <span class="math inline">a</span> e a <span
class="math inline">\gamma</span>, rispettivamente.</p></li>
</ul>
</section>
<section id="implementazione" class="slide level1">
<h1>Implementazione</h1>
<p>Le attività da compiere sul codice sono le seguenti:</p>
<ol>
<li>Definire una funzione che calcoli la luminosità di un oggetto
<code>Color</code>;</li>
<li>Definire una funzione che calcoli la luminosità media di un
<code>HdrImage</code>;</li>
<li>Definire una funzione che normalizzi i valori di un
<code>HdrImage</code> usando una certa luminosità media, opzionalmente
passata come argomento;</li>
<li>Definire una funzione che applichi la correzione per le sorgenti
luminose;</li>
<li>Implementare il <code>main</code> nel codice dell’applicazione.</li>
</ol>
</section>
<section id="luminosità-12" class="slide level1">
<h1>Luminosità (1/2)</h1>
<ul>
<li><p>Aggiungiamo un semplice metodo <code>luminosity</code> alla
classe <code>Color</code>, che restituisce il valore della luminosità
suggerito da Shirley &amp; Morley:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Color:</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> luminosity(<span class="va">self</span>):</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="bu">max</span>(<span class="va">self</span>.r, <span class="va">self</span>.g, <span class="va">self</span>.b) <span class="op">+</span> <span class="bu">min</span>(<span class="va">self</span>.r, <span class="va">self</span>.g, <span class="va">self</span>.b)) <span class="op">/</span> <span class="dv">2</span></span></code></pre></div></li>
<li><p>Se nel vostro linguaggio l’equivalente di <code>max</code> e
<code>min</code> accetta solo due parametri (es., <code>minOf</code> e
<code>maxOf</code> in Kotlin), potete usare l’equivalenza</p>
<p><span class="math display">
\max\left\{a, b, c\right\} \equiv \max\bigl\{\max\left\{a, b\right\},
c\bigr\}.
</span></p></li>
</ul>
</section>
<section id="luminosità-22" class="slide level1">
<h1>Luminosità (2/2)</h1>
<ul>
<li><p>Occorrono anche alcuni test per
<code>Color.luminosity</code>:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_luminosity():</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    col1 <span class="op">=</span> Color(<span class="fl">1.0</span>, <span class="fl">2.0</span>, <span class="fl">3.0</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    col2 <span class="op">=</span> Color(<span class="fl">9.0</span>, <span class="fl">5.0</span>, <span class="fl">7.0</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> pytest.approx(<span class="fl">2.0</span>) <span class="op">==</span> col1.luminosity()</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> pytest.approx(<span class="fl">7.0</span>) <span class="op">==</span> col2.luminosity()</span></code></pre></div></li>
<li><p>Il metodo <code>pytest.approx()</code> fa parte della libreria
<code>pytest</code>, e corrisponde alla funzione <code>is_close</code>
che avete implementato tempo fa.</p></li>
</ul>
</section>
<section id="luminosità-media-12" class="slide level1">
<h1>Luminosità media (1/2)</h1>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HdrImage:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> average_luminosity(<span class="va">self</span>, delta<span class="op">=</span><span class="fl">1e-10</span>):</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        cumsum <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> pix <span class="kw">in</span> <span class="va">self</span>.pixels:</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>            cumsum <span class="op">+=</span> math.log10(delta <span class="op">+</span> pix.luminosity())</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> math.<span class="bu">pow</span>(<span class="dv">10</span>, cumsum <span class="op">/</span> <span class="bu">len</span>(<span class="va">self</span>.pixels))</span></code></pre></div>
</section>
<section id="luminosità-media-22" class="slide level1">
<h1>Luminosità media (2/2)</h1>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_average_luminosity():</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> HdrImage(<span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    img.set_pixel(<span class="dv">0</span>, <span class="dv">0</span>, Color(  <span class="fl">5.0</span>,   <span class="fl">10.0</span>,   <span class="fl">15.0</span>))  <span class="co"># Luminosity: 10.0</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    img.set_pixel(<span class="dv">1</span>, <span class="dv">0</span>, Color(<span class="fl">500.0</span>, <span class="fl">1000.0</span>, <span class="fl">1500.0</span>))  <span class="co"># Luminosity: 1000.0</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(img.average_luminosity(delta<span class="op">=</span><span class="fl">0.0</span>))</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> pytest.approx(<span class="fl">100.0</span>) <span class="op">==</span> img.average_luminosity(delta<span class="op">=</span><span class="fl">0.0</span>)</span></code></pre></div>
</section>
<section id="normalizzazione-13" class="slide level1">
<h1>Normalizzazione (1/3)</h1>
<ul>
<li><p>La funzione <code>normalize_image</code> calcola la luminosità
media di un’immagine secondo l’<a
href="tomasi-ray-tracing-05b-external-libraries.html#/normalizzazione">equazione
corrispondente</a>.</p></li>
<li><p>La funzione dovrebbe accettare il valore di <span
class="math inline">a</span> come parametro di input:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize_image(<span class="va">self</span>, factor, luminosity<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> luminosity:</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        luminosity <span class="op">=</span> <span class="va">self</span>.average_luminosity()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(<span class="va">self</span>.pixels)):</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pixels[i] <span class="op">=</span> <span class="va">self</span>.pixels[i] <span class="op">*</span> (factor <span class="op">/</span> luminosity)</span></code></pre></div></li>
</ul>
</section>
<section id="normalizzazione-23" class="slide level1">
<h1>Normalizzazione (2/3)</h1>
<ul>
<li><p>È bene accettare la luminosità come parametro anziché
calcolarla:</p>
<ul>
<li>Nei test, ci può fare comodo passare diversi valori per la
luminosità;</li>
<li>L’utente potrebbe voler specificare questo valore.</li>
</ul></li>
<li><p>Se il vostro linguaggio supporta i tipi opzionali, potete
chiamare la funzione <code>average_luminosity</code> se il parametro
luminosità è nullo:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// This is C#; in Kotlin it&#39;s almost the same.</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">NormalizeImage</span><span class="op">(</span><span class="dt">float</span> factor<span class="op">,</span> <span class="dt">float</span><span class="op">?</span> luminosity <span class="op">=</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// In Kotlin use &quot;?:&quot; instead of &quot;??&quot;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> lum <span class="op">=</span> luminosity <span class="op">??</span> <span class="fu">AverageLuminosity</span><span class="op">();</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> pixels<span class="op">.</span><span class="fu">Length</span><span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span> <span class="co">/* ... */</span> <span class="op">}</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
</ul>
</section>
<section id="normalizzazione-33" class="slide level1">
<h1>Normalizzazione (3/3)</h1>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_normalize_image():</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> HdrImage(<span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    img.set_pixel(<span class="dv">0</span>, <span class="dv">0</span>, Color(  <span class="fl">5.0</span>,   <span class="fl">10.0</span>,   <span class="fl">15.0</span>))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    img.set_pixel(<span class="dv">1</span>, <span class="dv">0</span>, Color(<span class="fl">500.0</span>, <span class="fl">1000.0</span>, <span class="fl">1500.0</span>))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    img.normalize_image(factor<span class="op">=</span><span class="fl">1000.0</span>, luminosity<span class="op">=</span><span class="fl">100.0</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> img.get_pixel(<span class="dv">0</span>, <span class="dv">0</span>).is_close(Color(<span class="fl">0.5e2</span>, <span class="fl">1.0e2</span>, <span class="fl">1.5e2</span>))</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> img.get_pixel(<span class="dv">1</span>, <span class="dv">0</span>).is_close(Color(<span class="fl">0.5e4</span>, <span class="fl">1.0e4</span>, <span class="fl">1.5e4</span>))</span></code></pre></div>
</section>
<section id="punti-luminosi-12" class="slide level1">
<h1>Punti luminosi (1/2)</h1>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _clamp(x: <span class="bu">float</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> x)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HdrImage:</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> clamp_image(<span class="va">self</span>):</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(<span class="va">self</span>.pixels)):</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.pixels[i].r <span class="op">=</span> _clamp(<span class="va">self</span>.pixels[i].r)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.pixels[i].g <span class="op">=</span> _clamp(<span class="va">self</span>.pixels[i].g)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.pixels[i].b <span class="op">=</span> _clamp(<span class="va">self</span>.pixels[i].b)</span></code></pre></div>
</section>
<section id="punti-luminosi-22" class="slide level1">
<h1>Punti luminosi (2/2)</h1>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_clamp_image():</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> HdrImage(<span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    img.set_pixel(<span class="dv">0</span>, <span class="dv">0</span>, Color(<span class="fl">0.5e1</span>, <span class="fl">1.0e1</span>, <span class="fl">1.5e1</span>))</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    img.set_pixel(<span class="dv">1</span>, <span class="dv">0</span>, Color(<span class="fl">0.5e3</span>, <span class="fl">1.0e3</span>, <span class="fl">1.5e3</span>))</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    img.clamp_image()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Just check that the R/G/B values are within the expected boundaries</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cur_pixel <span class="kw">in</span> img.pixels:</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> (cur_pixel.r <span class="op">&gt;=</span> <span class="dv">0</span>) <span class="kw">and</span> (cur_pixel.r <span class="op">&lt;=</span> <span class="dv">1</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> (cur_pixel.g <span class="op">&gt;=</span> <span class="dv">0</span>) <span class="kw">and</span> (cur_pixel.g <span class="op">&lt;=</span> <span class="dv">1</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> (cur_pixel.b <span class="op">&gt;=</span> <span class="dv">0</span>) <span class="kw">and</span> (cur_pixel.b <span class="op">&lt;=</span> <span class="dv">1</span>)</span></code></pre></div>
</section>
<section id="gestione-di-dipendenze" class="slide level1">
<h1>Gestione di dipendenze</h1>
</section>
<section id="gestione-di-dipendenze-1" class="slide level1">
<h1>Gestione di dipendenze</h1>
<ul>
<li>Implementare il codice per salvare un’immagine in uno dei formati
LDR più diffusi (PNG, JPEG, TIFF, WebP) sarebbe interessantissimo, ma
molto complesso!</li>
<li>Implementeremo questa funzionalità appoggiandoci a una libreria
esterna</li>
<li>In questo modo impareremo come il linguaggio che stiamo usando
consente di gestire le dipendenze</li>
</ul>
</section>
<section id="librerie-di-sistema" class="slide level1">
<h1>Librerie di sistema</h1>
<center>
<img data-src="media/dependencies-simple.svg" />
</center>
<ul>
<li><p>Questo genere di librerie di solito si installano usando in
qualche modo <code>sudo</code>, come ad esempio
<code>./configure &amp;&amp; make &amp;&amp; sudo make install</code></p></li>
<li><p>Esempio: installare ROOT sul proprio sistema per lavorare alle
esercitazioni di TNDS!</p></li>
</ul>
</section>
<section id="librerie-di-sistema-1" class="slide level1">
<h1>Librerie di sistema</h1>
<p>Capita però spesso che si debbano usare librerie
<em>incompatibili</em> nei propri codici! Supponiamo di avere numerosi
oscilloscopi in un laboratorio di elettronica, e che usiamo la libreria
<code>oscilloscope</code> per analizzarne le misure:</p>
<ul>
<li><p>Sinora abbiamo utilizzato la versione 2.4 per scrivere molti
codici di analisi usati regolarmente</p></li>
<li><p>È però uscita ormai da un po’ la versione 3.0 di
<code>oscilloscope</code>, che ha nuove funzionalità interessanti, ma
non ho ancora fatto l’aggiornamento perché è incompatibile con la
versione 2.4!</p></li>
<li><p>Sta per uscire la versione 4.0, ancora più potente, ma non
supporterà più uno dei miei vecchi oscilloscopi, che mi è ancora
indispensabile.</p></li>
</ul>
</section>
<section id="librerie-locali" class="slide level1">
<h1>Librerie locali</h1>
<p>Le librerie locali risolvono questi problemi perché non vengono
installate a livello di sistema, ma sono legate a un singolo
<em>repository</em>:</p>
<center>
<img data-src="media/dependencies-complex.svg" />
</center>
<ul>
<li><p>Esempio: copia di una libreria <em>header-only</em> nel proprio
progetto C++</p></li>
<li><p>Esempio: <a
href="https://docs.python.org/3/tutorial/venv.html"><em>virtual
environment</em></a> in Python</p></li>
</ul>
</section>
<section id="gestione-di-dipendenze-2" class="slide level1">
<h1>Gestione di dipendenze</h1>
<ul>
<li><p>Quasi tutti i linguaggi supportano una gestione di librerie
«locali» (sigh! non il C++)</p></li>
<li><p>Queste funzionalità sono solitamente implementate nei programmi
che avete usato sinora per creare progetti (<code>dotnet</code>,
<code>dub</code>, <code>nimble</code>, <code>cargo</code>…)</p></li>
<li><p>Scegliete quindi una libreria che supporti la <em>scrittura</em>
di immagini LDR e importatela nel vostro progetto come una dipendenza
<strong>locale</strong> (niente <code>sudo</code>!)</p></li>
<li><p>L’uso di librerie locali ci aiuterà molto quando affronteremo la
<em>continuous integration</em>.</p></li>
</ul>
</section>
<section id="produzione-di-immagini-ldr" class="slide level1">
<h1>Produzione di immagini LDR</h1>
</section>
<section id="conversione-a-ldr-13" class="slide level1">
<h1>Conversione a LDR (1/3)</h1>
<ul>
<li>Una volta applicata <code>normalize_image</code> e
<code>clamp_image</code>, tutte le componenti RGB dei colori nella
matrice saranno nell’intervallo [0, 1].</li>
<li>A questo punto la conversione nello spazio sRGB avviene tramite la
<a
href="tomasi-ray-tracing-05b-ci-builds.html#/correzione-%CE%B3">solita
formula con γ</a>.</li>
<li>Il risultato della conversione è una matrice che va salvata in un
formato grafico LDR: PNG, JPEG, WebP…</li>
<li>Per il salvataggio dovete scegliere una libreria appropriata.</li>
</ul>
</section>
<section id="conversione-a-ldr-23" class="slide level1">
<h1>Conversione a LDR (2/3)</h1>
<table>
<colgroup>
<col style="width: 11%" />
<col style="width: 88%" />
</colgroup>
<thead>
<tr class="header">
<th>Linguaggio</th>
<th>Librerie</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>C#</td>
<td><a
href="https://docs.sixlabors.com/articles/imagesharp/?tabs=tabid-1">ImageSharp</a></td>
</tr>
<tr class="even">
<td>D</td>
<td><a
href="https://code.dlang.org/packages/imageformats">imageformats</a></td>
</tr>
<tr class="odd">
<td>Java/Kotlin</td>
<td><a
href="https://docs.oracle.com/javase/8/docs/api/javax/imageio/ImageIO.html">javax.imageio</a>
(già installato)</td>
</tr>
<tr class="even">
<td>Nim</td>
<td><a
href="https://github.com/jrenner/nim-simplepng">simplepng</a></td>
</tr>
<tr class="odd">
<td>Python</td>
<td><a href="https://pillow.readthedocs.io/en/stable/">Pillow</a></td>
</tr>
<tr class="even">
<td>Rust</td>
<td><a href="https://crates.io/crates/image">image</a></td>
</tr>
</tbody>
</table>
<p>Potete scegliere altre librerie, ma attenzione a scegliere quelle
pixel-based!</p>
</section>
<section id="cosa-ci-serve" class="slide level1">
<h1>Cosa ci serve</h1>
<p>Scegliete una libreria LDR che abbia queste caratteristiche:</p>
<ul>
<li>Creazione di una immagine specificando numero di colonne
(<code>width</code>) e numero di righe (<code>height</code>)</li>
<li>Impostazione del valore sRGB di un pixel date le sue coordinate
<code>x</code> e <code>y</code></li>
<li>Salvataggio dell’immagine in un formato grafico diffuso</li>
<li>Fate molta attenzione al sistema di coordinate: il pixel a
<code>(0, 0)</code> è in alto a sinistra? in basso a sinistra?
oppure…?</li>
</ul>
</section>
<section id="conversione-a-ldr-33" class="slide level1">
<h1>Conversione a LDR (3/3)</h1>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HdrImage:</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> write_ldr_image(<span class="va">self</span>, stream, <span class="bu">format</span>, gamma<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> Image.new(<span class="st">&quot;RGB&quot;</span>, (<span class="va">self</span>.width, <span class="va">self</span>.height))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.height):</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.width):</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                cur_color <span class="op">=</span> <span class="va">self</span>.get_pixel(x, y)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>                img.putpixel(xy<span class="op">=</span>(x, y), value<span class="op">=</span>(</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">int</span>(<span class="dv">255</span> <span class="op">*</span> math.<span class="bu">pow</span>(cur_color.r, <span class="dv">1</span> <span class="op">/</span> gamma)),</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">int</span>(<span class="dv">255</span> <span class="op">*</span> math.<span class="bu">pow</span>(cur_color.g, <span class="dv">1</span> <span class="op">/</span> gamma)),</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">int</span>(<span class="dv">255</span> <span class="op">*</span> math.<span class="bu">pow</span>(cur_color.b, <span class="dv">1</span> <span class="op">/</span> gamma)),</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                ))</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        img.save(stream, <span class="bu">format</span><span class="op">=</span><span class="bu">format</span>)</span></code></pre></div>
</section>
<section id="funzione-main-12" class="slide level1">
<h1>Funzione <code>main</code> (1/2)</h1>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Parameters:</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    input_pfm_file_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    factor:<span class="bu">float</span> <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    gamma:<span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    output_png_file_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> parse_command_line(<span class="va">self</span>, argv):</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(sys.argv) <span class="op">!=</span> <span class="dv">5</span>:</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="st">&quot;Usage: main.py INPUT_PFM_FILE FACTOR GAMMA OUTPUT_PNG_FILE&quot;</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.input_pfm_file_name <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.factor <span class="op">=</span> <span class="bu">float</span>(sys.argv[<span class="dv">2</span>])</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="ss">f&quot;Invalid factor (&#39;</span><span class="sc">{</span>sys<span class="sc">.</span>argv[<span class="dv">2</span>]<span class="sc">}</span><span class="ss">&#39;), it must be a floating-point number.&quot;</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.gamma <span class="op">=</span> <span class="bu">float</span>(sys.argv[<span class="dv">3</span>])</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="ss">f&quot;Invalid gamma (&#39;</span><span class="sc">{</span>sys<span class="sc">.</span>argv[<span class="dv">3</span>]<span class="sc">}</span><span class="ss">&#39;), it must be a floating-point number.&quot;</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_png_file_name <span class="op">=</span> sys.argv[<span class="dv">4</span>]</span></code></pre></div>
<p>(Anziché usare variabili globali per i parametri letti da
<code>argv</code>, uso una <code>struct</code> che poi passo alle varie
funzioni: è più facile scrivere test!)</p>
</section>
<section id="funzione-main-22" class="slide level1">
<h1>Funzione <code>main</code> (2/2)</h1>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main(argv):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    parameters <span class="op">=</span> Parameters()</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        parameters.parse_command_line(argv)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">RuntimeError</span> <span class="im">as</span> err:</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Error: &quot;</span>, err)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(parameters.input_pfm_file_name, <span class="st">&quot;rb&quot;</span>) <span class="im">as</span> inpf:</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> hdrimages.read_pfm_image(inpf)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;File </span><span class="sc">{</span>parameters<span class="sc">.</span>input_pfm_file_name<span class="sc">}</span><span class="ss"> has been read from disk.&quot;</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    img.normalize_image(factor<span class="op">=</span>parameters.factor)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    img.clamp_image()</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(parameters.output_png_file_name, <span class="st">&quot;wb&quot;</span>) <span class="im">as</span> outf:</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        img.write_ldr_image(stream<span class="op">=</span>outf, <span class="bu">format</span><span class="op">=</span><span class="st">&quot;PNG&quot;</span>, gamma<span class="op">=</span>parameters.gamma)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;File </span><span class="sc">{</span>parameters<span class="sc">.</span>output_png_file_name<span class="sc">}</span><span class="ss"> has been written to disk.&quot;</span>)</span></code></pre></div>
</section>
<section id="guida-per-lesercitazione" class="slide level1">
<h1>Guida per l’esercitazione</h1>
</section>
<section id="guida-per-lesercitazione-1" class="slide level1">
<h1>Guida per l’esercitazione</h1>
<ol>
<li>Definire una funzione che calcoli la luminosità di un oggetto
<code>Color</code> e la luminosità media di un
<code>HdrImage</code>;</li>
<li>Definire una funzione che normalizzi i valori di un
<code>HdrImage</code> usando una certa luminosità media, opzionalmente
passata come argomento;</li>
<li>Definire una funzione che applichi la correzione per le sorgenti
luminose;</li>
<li>Implementare il <code>main</code> nel codice dell’applicazione, in
modo che accetti 4 argomenti: il file PFM da leggere, il valore di <span
class="math inline">a</span>, il valore di γ, e il nome del file
PNG/JPEG/etc. da creare.</li>
<li>Aggiungete <em>docstrings</em> a quelle classi, metodi, funzioni,
tipi, etc. che vi sembrano bisognose di ciò, ma preoccupatevi che
ciascun commento <strong>non sia pedante</strong>.</li>
<li>Scegliete insieme una <a
href="./tomasi-ray-tracing-04a.html#/licenze-duso">licenza
d’uso</a>.</li>
</ol>
</section>
<section id="immagini-di-riferimento" class="slide level1">
<h1>Immagini di riferimento</h1>
<ul>
<li><p>Se vi serve un’immagine PFM realistica, potete usare <a
href="http://www.pauldebevec.com/Research/HDR/memorial.pfm">memorial.pfm</a>.</p></li>
<li><p>C’è anche il sito <a
href="https://www.pbrt.org/scenes-v3.html">Scenes for
pbrt-v3</a>.</p></li>
</ul>
</section>
<section id="indicazioni-per-c" class="slide level1">
<h1>Indicazioni per C#</h1>
</section>
<section id="importare-librerie" class="slide level1">
<h1>Importare librerie</h1>
<ul>
<li><p>La libreria ImageSharp supporta molti formati: JPEG, PNG, BMP,
GIF, e TGA (un vecchio formato che non abbiamo trattato nella lezione di
teoria).</p></li>
<li><p>In C# si possono scaricare e installare automaticamente librerie,
e specificare che vanno impiegate nei propri progetti senza bisogno di
modificare Makefile e di usare <code>root-config</code>,
<code>pkg-config</code> e cose simili.</p></li>
<li><p>Aggiungete il package <a
href="https://docs.sixlabors.com/index.html">SixLabors.ImageSharp</a>
alla libreria di classi (che forse avete chiamato
<code>Tracer</code>):</p>
<pre class="text"><code>$ dotnet add package SixLabors.ImageSharp</code></pre></li>
</ul>
</section>
<section id="salvare-file-png" class="slide level1">
<h1>Salvare file PNG</h1>
<div class="sourceCode" id="cb15"><pre
class="sourceCode csharp"><code class="sourceCode cs"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a sRGB bitmap</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> bitmap <span class="op">=</span> <span class="kw">new</span> Image<span class="op">&lt;</span>Rgb24<span class="op">&gt;(</span>Configuration<span class="op">.</span><span class="fu">Default</span><span class="op">,</span> width<span class="op">,</span> height<span class="op">);</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">// The bitmap can be used as a matrix. To draw the pixels in the bitmap</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">// just use the syntax &quot;bitmap[x, y]&quot; like the following:</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>bitmap<span class="op">[</span>SOMEX<span class="op">,</span> SOMEY<span class="op">]</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">Rgb24</span><span class="op">(</span><span class="dv">255</span><span class="op">,</span> <span class="dv">255</span><span class="op">,</span> <span class="dv">128</span><span class="op">);</span> <span class="co">// Three &quot;Byte&quot; values!</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Save the bitmap as a PNG file</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="op">(</span>Stream fileStream <span class="op">=</span> File<span class="op">.</span><span class="fu">OpenWrite</span><span class="op">(</span><span class="st">&quot;output.png&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    bitmap<span class="op">.</span><span class="fu">Save</span><span class="op">(</span>fileStream<span class="op">,</span> <span class="kw">new</span> <span class="fu">PngEncoder</span><span class="op">());</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="indicazioni-per-dnimrust" class="slide level1">
<h1>Indicazioni per D/Nim/Rust</h1>
</section>
<section id="indicazioni-per-dnimrust-1" class="slide level1">
<h1>Indicazioni per D/Nim/Rust</h1>
<ul>
<li><p>Similmente al C#, potete installare librerie nel vostro progetto
con il vostro package manager:</p>
<ul>
<li>In D, usate <code>dub add NAME</code>;</li>
<li>In Nim, usate <code>nimble install NAME</code>;</li>
<li>In Cargo, usate <code>cargo</code> seguendo <a
href="https://doc.rust-lang.org/cargo/guide/dependencies.html">la
guida</a>.</li>
</ul></li>
<li><p>Queste librerie saranno installate come dipendenze del vostro
programma, e non a livello di sistema.</p></li>
</ul>
</section>
<section id="indicazioni-per-javakotlin" class="slide level1">
<h1>Indicazioni per Java/Kotlin</h1>
</section>
<section id="indicazioni-per-javakotlin-1" class="slide level1">
<h1>Indicazioni per Java/Kotlin</h1>
<ul>
<li><p>A differenza di Python, C++, C# e Julia, sia Java che Kotlin
forniscono supporto per immagini PNG, JPEG, BMP e GIF tramite le
librerie standard Java.</p></li>
<li><p>A voi servono le classi <code>java.awt.image.BufferedImage</code>
(immagine LDR) e <code>javax.imageio.ImageIO</code> (la classe che
implementa i metodi per leggere/scrivere immagini LDR su file).</p></li>
</ul>
</section>
<section id="codificare-il-colore" class="slide level1">
<h1>Codificare il colore</h1>
<ul>
<li><p>La classe <code>BufferedImage</code> permette di codificare il
colore in tanti modi diversi. Se usate <code>TYPE_INT_RGB</code>, il
colore è un numero intero a 32 bit anziché una terna RGB.</p></li>
<li><p>I 32 bit del numero che codifica un colore seguono questo
formato:</p>
<pre><code>00000000 rrrrrrrr gggggggg bbbbbbbb</code></pre>
<p>dove <code>r</code> sono i bit del rosso, <code>g</code> quelli del
verde e <code>b</code> quelli del blu. Di solito i colori si indicano
usando la notazione esadecimale, perché in questo modo sono sempre a sei
cifre, ad es. <code>0x12FA51</code>.</p></li>
<li><p>Se <code>r</code>, <code>g</code> e <code>b</code> sono byte
nell’intervallo [0, 255], potete usare la formula
<code>r * 65536 + g * 256 + b</code> oppure
<code>(r shl 16) + (g shl 8) + b</code>.</p></li>
</ul>
</section>
<section id="esempio-di-codice-kotlin" class="slide level1">
<h1>Esempio di codice Kotlin</h1>
<div class="sourceCode" id="cb17"><pre
class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">width</span> <span class="op">=</span> <span class="dv">800</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">height</span> <span class="op">=</span> <span class="dv">600</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">ldrImage</span> <span class="op">=</span> BufferedImage<span class="op">(</span>width<span class="op">,</span> height<span class="op">,</span> BufferedImage<span class="op">.</span>TYPE_INT_RGB<span class="op">)</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>y <span class="kw">in</span> <span class="dv">0</span> until height<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>x <span class="kw">in</span> <span class="dv">0</span> until width<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 0xFF0000 corresponds to sRGB(255, 0, 0): the image will be</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>            <span class="co">// painted uniformly with a bright red shade</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>            ldrImage<span class="op">.</span>setRGB<span class="op">(</span>x<span class="op">,</span> y<span class="op">,</span> <span class="bn">0xFF0000</span><span class="op">)</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Save the image to the file specified on the command line</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    ImageIO<span class="op">.</span>write<span class="op">(</span>args<span class="op">[</span><span class="dv">0</span><span class="op">],</span> <span class="st">&quot;PNG&quot;</span><span class="op">,</span> stream<span class="op">)</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="linea-di-comando" class="slide level1">
<h1>Linea di comando</h1>
<ul>
<li><p>Java e Kotlin hanno un modo un po’ «barocco» di gestire i
parametri da linea di comando.</p></li>
<li><p>Il vostro eseguibile *non può** essere eseguito come un normale
eseguibile Python/C++/C#:</p>
<pre class="text"><code>$ ./main.py input_file.pfm 0.3 1.0 output_file.png</code></pre>
<p>perché è compilato per la JVM.</p></li>
<li><p>Se usate Kotlin, bisogna passare da <code>gradlew</code>, che
richiede che i parametri siano passati attraverso
<code>--args</code>:</p>
<pre class="text"><code>./gradlew run --args=&quot;input_file.pfm 0.3 1.0 output_file.png&quot;</code></pre></li>
</ul>
</section>
    </div>
  </div>

  <script src="https://unpkg.com/reveal.js@^4//dist/reveal.js"></script>

  <!-- reveal.js plugins -->
  <script src="https://unpkg.com/reveal.js@^4//plugin/notes/notes.js"></script>
  <script src="https://unpkg.com/reveal.js@^4//plugin/search/search.js"></script>
  <script src="https://unpkg.com/reveal.js@^4//plugin/zoom/zoom.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
        // Display controls in the bottom right corner
        controls: true,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: true,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'bottom-right',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: true,

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: true,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'default',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: true,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'slide',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'fade',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

       // Parallax background image
       parallaxBackgroundImage: './media/background.png', // e.g. "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'"

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1440,

        height: 810,

        // reveal.js plugins
        plugins: [
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script src="js/asciinema-player.js"></script>
    <script src="https://cdn.plot.ly/plotly-1.58.4.min.js"></script>
    <script type="text/javascript" src="./js/quantization.js"></script>
    </body>
</html>
